name: Claude PR Description

on:
  workflow_call:
    inputs:
      trigger_phrase:
        description: 'Phrase to trigger PR description generation'
        required: false
        default: '@claude-pr-describe'
        type: string
      max_turns:
        description: 'Maximum conversation turns'
        required: false
        default: 1
        type: number
      custom_template:
        description: 'Custom PR description template'
        required: false
        default: ''
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API Key'
        required: true

jobs:
  claude-pr-description:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request && 
      contains(github.event.comment.body, inputs.trigger_phrase)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git and GitHub CLI
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status
          gh repo view --json url,owner,name

      - name: Run Claude PR Description Generator
        uses: github-claude/claude-action@v1
        with:
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr view *)"
            --max-turns ${{ inputs.max_turns }}
            ${{ inputs.trigger_phrase != '@claude-pr-describe' && format('--trigger_phrase "{0}"', inputs.trigger_phrase) || '' }}
            --system-prompt "å¸¸ã«æ—¥æœ¬èªã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã¯PRèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¦PRæœ¬ä½“ã‚’ç›´æ¥æ›´æ–°ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ '${{ inputs.trigger_phrase }}' ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸãŸã‚ã€ã“ã®PRã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã—ã¾ã™ã€‚

            ${{ inputs.custom_template != '' && format('ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„: {0}', inputs.custom_template) || 
            'ä»¥ä¸‹ã®å½¢å¼ã§æ§‹é€ åŒ–ã•ã‚ŒãŸèª¬æ˜æ–‡ã‚’ä½œæˆ:

            ## ğŸ“‹ å¤‰æ›´å†…å®¹ã®æ¦‚è¦
            - ã“ã®PRã§ä½•ã‚’å®Ÿè£…/ä¿®æ­£ã—ãŸã‹ã‚’ç°¡æ½”ã«èª¬æ˜

            ## ğŸ” å¤‰æ›´è©³ç´°
            - ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®å¤‰æ›´å†…å®¹
            - è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£ã•ã‚ŒãŸæ©Ÿèƒ½

            ## âœ… ç¢ºèªäº‹é …
            - [ ] å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†
            - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§

            ## ğŸš€ å½±éŸ¿ç¯„å›²
            - ã“ã®å¤‰æ›´ãŒä¸ãˆã‚‹å½±éŸ¿
            - æ³¨æ„ã™ã¹ãç‚¹ã‚„ãƒªã‚¹ã‚¯

            ## ğŸ“ å‚™è€ƒ
            - ãã®ä»–è£œè¶³äº‹é …ãŒã‚ã‚Œã°è¨˜è¼‰' }}

            é‡è¦: å¿…ãšä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¦PRæœ¬ä½“ã®èª¬æ˜æ–‡ã‚’æ›´æ–°ã—ã¦ãã ã•ã„:
            1. 'gh pr view --json number,title,body' ã§PRæƒ…å ±ã‚’å–å¾—
            2. Gitå·®åˆ†ã‚’åˆ†æã—ã¦èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
            3. 'gh pr edit --body \"[èª¬æ˜æ–‡]\"' ã‚’å®Ÿè¡Œã—ã¦PRæœ¬ä½“ã‚’æ›´æ–°
            4. æ›´æ–°å®Œäº†ã‚’å ±å‘Š"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
